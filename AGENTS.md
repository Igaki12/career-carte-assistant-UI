# Career Carte Assistant – エージェント設計メモ

## 1. プロジェクトのゴールと開発方針
- **APIキー入力モーダル / チャットUI / カルテ更新ロジック / 音声入出力 / VRMステージ** の5要素は現状の実装で一通り動作確認済み。引き続き安定性と保守性を重視しつつ改善を行う。
- UIはモバイル優先で整備する。最新ビルドでは **カルテ閲覧をモーダル化**（「今までの話を整理してカルテを確認」ボタン経由）し、VRMステージ右下にも進捗バッジを重ねることで狭い画面でも情報を把握しやすくした。
- 調査済みの「次世代医療面接AIシステム」資料を土台に、日本型事前問診のスロット充填と海外アンビエントAIの書記体験を融合したUI/UX像を継続的に目指す。

## 2. 技術スタックとOpenAI APIの使い方
- クライアント：Vite + React + TypeScript。UIはChakra UI、3D表現は Three.js + @pixiv/three-vrm（OrbitControls を固定視点化）。
- 会話モデル：現状は `/v1/chat/completions` へ `gpt-4o` を指定して呼び出している（`buildSystemPrompt` 経由でモード別プロンプトを生成）。将来的に `gpt-5.1` + json_schema へ移行する計画を維持。
- 音声合成：OpenAI Text-to-Speechガイド[^2]準拠で `tts-1` / voice `sage` を利用。再生時は 1.2x に設定し、発話中は Surprised 0.05–0.3 で VRM 表情に揺らぎを与える。
- 音声入力：ブラウザ録音（MediaRecorder）→ Whisper (`whisper-1`) で STT → テキストエリアへ挿入という流れ。Realtime API 置き換えに備えて `processAudio` など関数単位で分割済み。
- Whisper → GPT-4o → TTS-1 のシーケンスは今後 Realtime API へ移行できるよう hook/utility を小さくまとめている。

[^1]: https://platform.openai.com/docs/guides/latest-model?lang=javascript  
[^2]: https://platform.openai.com/docs/guides/text-to-speech

## 3. 問診AIのリサーチから得た重要示唆
1. **7つの主訴項目（キャリアカルテ版）**  
   - 医療カルテのメソッドを踏襲しつつ、以下の標準スロットを JSON 管理する。企業ごとに ON/OFF や文言差し替えが可能。  
     - **A. 主訴**（いま困っていること・話したいこと）  
     - **B. キャリア歴**（経験・強み・転機）  
     - **C. 現在の業務状況**（役割／満足点／不満点）  
     - **D. キャリア観・価値観**  
     - **E. 将来イメージ**（3〜5年後）  
     - **F. 学び・成長ニーズ**  
     - **G. 面談で話したいテーマ**（期待点）  
   - 各セクションは **3〜5往復を上限**とし、全体は **15〜20分**で自然にクロージングするようターン制御。  
   - Structured Outputs（response_format: json_schema）でスロットを厳密化し、カルテ用データを直接出力できるよう準備する。

2. **国内外のアーキテクチャ比較**  
   - 日本：Ubie や SymView が代表する「事前問診」文化。患者入力ベースでトリアージとカルテ補助を完結。  
   - 海外：Ambience Healthcare や Nabla、Corti など「アンビエント・スクライブ」型。医師と患者の会話をリアルタイムで書記化し、請求・CDI まで支援。  
   - 今回のプロジェクトは、日本型のスロット充填と海外型の自然対話スクライブを **LangGraph的オーケストレーション** で統合するハイブリッド像を目指す。

3. **将来展望**  
   - Realtime API + VAD で割り込み可能な音声対話を実装 → AIが不足情報を能動的に確認。  
   - 医療ガイドラインをRAGで参照し、ハルシネーションを抑制。  
   - 「AIレジデント」として予備問診〜鑑別疾患提示〜サマリ作成までを自動連携するロードマップを描く。

## 4. 現状のコンポーネント状況
| コンポーネント | 状態 | 留意点 |
| --- | --- | --- |
| ApiKeyModal / LocalStorage | ✅ | ローカルストレージへの保存・再入力導線を維持 |
| モード切替 (順次ヒアリング / 自由対話) | ✅ | `buildSystemPrompt` でモード別プロンプトを生成。自由対話モードはカルテ強制整理フローを備える |
| Whisper STT / マイク録音 | ✅ | MediaRecorder → `whisper-1`。ブラウザ互換性を継続監視 |
| GPT チャット制御 | ✅ | 現状 `gpt-4o` + `response_format: json_object`。JSON Schema 化を次フェーズで実施予定 |
| カルテ UI (7スロット) | ✅ | 通常は非表示。ボタン押下でモーダル表示（70dvh スクロール）& VRM 右下の進捗オーバーレイで常時進捗を把握可能 |
| VRM ステージ | ✅ | 背景切替・Blink/Nod/Surprised 制御・進捗バッジ重ね表示。低スペック端末の FPS に注意 |

## 5. 次のマイルストーン
1. **モバイル最適化の継続**  
   - チャット + VRM の縦並びは完了。次はモーダル内 CTA のタップ領域、マイクボタンの片手操作最適化を行う。  
2. **Structured Output 対応**  
   - `response_format: json_schema` と KarteData の型連携、7スロットの厳格チェック、完了判定の明文化を実装。  
3. **カルテ送信フローの実装**  
   - 「これで提出」ボタンから待機画面（または送信完了ダイアログ）へ遷移させ、Xserver VPS 側 API との接続を見据えたダミー送信を用意。  
4. **Xserver VPS / バックエンド計画**  
   - Node.js + MySQL + REST API を想定したエンドポイント・認証フローの仕様書化。GitHub Pages 上のフロントをそのまま接続できるようデータ構造を固定する。

以上をロードマップとして、まずは全ユニットの安定動作を確保し、その後モバイル表示と高度対話制御を段階的に実装していく。***
